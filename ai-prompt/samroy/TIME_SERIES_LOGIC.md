# Logic Chi Ti·∫øt: Xu H∆∞·ªõng 7 Ng√†y Qua

## üìä T·ªïng Quan

Bi·ªÉu ƒë·ªì **"Xu H∆∞·ªõng 7 Ng√†y Qua"** hi·ªÉn th·ªã s·ªë l∆∞·ª£ng **users m·ªõi** v√† **posts m·ªõi** ƒë∆∞·ª£c t·∫°o trong 7 ng√†y g·∫ßn ƒë√¢y nh·∫•t. ƒê√¢y l√† Line Chart (bi·ªÉu ƒë·ªì ƒë∆∞·ªùng) cho ph√©p so s√°nh xu h∆∞·ªõng tƒÉng tr∆∞·ªüng gi·ªØa 2 metrics.

---

## üîÑ Flow T·ªïng Th·ªÉ

```
Dashboard Page (page.tsx)
    ‚Üì
React Query: getTimeSeriesData(7)
    ‚Üì
Fetch ALL users & posts from database
    ‚Üì
Process & Filter data by date ranges
    ‚Üì
Return array of 7 data points
    ‚Üì
DashboardCharts Component
    ‚Üì
Recharts LineChart renders
```

---

## üìù Chi Ti·∫øt T·ª´ng B∆∞·ªõc

### B∆∞·ªõc 1: Fetch Data (Dashboard Page)

**File**: `apps/web/app/(dashboard)/admin/page.tsx`

```typescript
const { data: timeSeriesData, isLoading: timeSeriesLoading } = useQuery({
  queryKey: ['admin-dashboard-timeseries'],
  queryFn: () => getTimeSeriesData(7), // Last 7 days
  refetchInterval: 60000, // Refetch m·ªói 60 gi√¢y
  staleTime: 30000, // D·ªØ li·ªáu fresh trong 30 gi√¢y
});
```

**Gi·∫£i th√≠ch:**

- ‚úÖ S·ª≠ d·ª•ng **React Query** ƒë·ªÉ fetch data t·ª± ƒë·ªông
- ‚úÖ G·ªçi function `getTimeSeriesData(7)` ƒë·ªÉ l·∫•y data 7 ng√†y
- ‚úÖ Auto-refresh m·ªói **60 gi√¢y** ƒë·ªÉ c√≥ data real-time
- ‚úÖ Cache data trong **30 gi√¢y** ƒë·ªÉ gi·∫£m API calls

---

### B∆∞·ªõc 2: Process Data (adminApi.ts)

**File**: `apps/web/lib/api/adminApi.ts`

#### 2.1. Fetch To√†n B·ªô Data

```typescript
const [accountsRes, postsRes] = await Promise.all([
  api.get<Account[]>('/accounts', { headers: getAuthHeaders() }),
  api.get<Post[]>('/posts/admin/all', { headers: getAuthHeaders() }),
]);

const accounts = accountsRes.data; // T·∫•t c·∫£ users
const posts = postsRes.data; // T·∫•t c·∫£ posts
```

**Gi·∫£i th√≠ch:**

- ‚úÖ D√πng `Promise.all()` ƒë·ªÉ fetch parallel (nhanh h∆°n)
- ‚úÖ L·∫•y **TO√ÄN B·ªò** users v√† posts t·ª´ database
- ‚úÖ K√®m JWT token trong headers ƒë·ªÉ authenticate

---

#### 2.2. Generate Date Range (7 ng√†y)

```typescript
const dateRange: TimeSeriesData[] = [];
const today = new Date();

// Loop ng∆∞·ª£c t·ª´ 6 ng√†y tr∆∞·ªõc ‚Üí h√¥m nay
for (let i = days - 1; i >= 0; i--) {
  const date = new Date(today);
  date.setDate(date.getDate() - i); // L√πi l·∫°i i ng√†y
  date.setHours(0, 0, 0, 0); // Set v·ªÅ 00:00:00

  // Date range: [date, nextDate)
  const nextDate = new Date(date);
  nextDate.setDate(nextDate.getDate() + 1); // Ng√†y k·∫ø ti·∫øp

  // ...
}
```

**V√≠ d·ª• c·ª• th·ªÉ** (gi·∫£ s·ª≠ h√¥m nay l√† 12/10/2025):

```
i = 6: date = 06/10/2025 00:00:00, nextDate = 07/10/2025 00:00:00
i = 5: date = 07/10/2025 00:00:00, nextDate = 08/10/2025 00:00:00
i = 4: date = 08/10/2025 00:00:00, nextDate = 09/10/2025 00:00:00
i = 3: date = 09/10/2025 00:00:00, nextDate = 10/10/2025 00:00:00
i = 2: date = 10/10/2025 00:00:00, nextDate = 11/10/2025 00:00:00
i = 1: date = 11/10/2025 00:00:00, nextDate = 12/10/2025 00:00:00
i = 0: date = 12/10/2025 00:00:00, nextDate = 13/10/2025 00:00:00 (h√¥m nay)
```

**T·∫°i sao loop ng∆∞·ª£c?**

- ‚úÖ ƒê·ªÉ data ƒë∆∞·ª£c s·∫Øp x·∫øp t·ª´ **c≈© ‚Üí m·ªõi** (left to right tr√™n chart)
- ‚úÖ i = 6: 6 ng√†y tr∆∞·ªõc
- ‚úÖ i = 0: h√¥m nay

---

#### 2.3. Filter Users & Posts Theo Ng√†y

```typescript
// ƒê·∫øm s·ªë users ƒë∆∞·ª£c t·∫°o trong kho·∫£ng [date, nextDate)
const usersCount = accounts.filter((a) => {
  const createdAt = new Date(a.createdAt);
  return createdAt >= date && createdAt < nextDate;
}).length;

// ƒê·∫øm s·ªë posts ƒë∆∞·ª£c t·∫°o trong kho·∫£ng [date, nextDate)
const postsCount = posts.filter((p) => {
  const createdAt = new Date(p.createdAt);
  return createdAt >= date && createdAt < nextDate;
}).length;
```

**Gi·∫£i th√≠ch:**

- ‚úÖ Filter theo `createdAt` field t·ª´ database
- ‚úÖ ƒêi·ªÅu ki·ªán: `createdAt >= date AND createdAt < nextDate`
- ‚úÖ T√≠nh s·ªë l∆∞·ª£ng b·∫±ng `.length`

**V√≠ d·ª•:**

```
Date: 10/10/2025 00:00:00 ‚Üí 11/10/2025 00:00:00

Users v·ªõi createdAt:
- 09/10/2025 23:59:59 ‚ùå (< date)
- 10/10/2025 00:00:00 ‚úÖ (>= date)
- 10/10/2025 12:30:00 ‚úÖ (trong kho·∫£ng)
- 10/10/2025 23:59:59 ‚úÖ (< nextDate)
- 11/10/2025 00:00:00 ‚ùå (>= nextDate)

‚Üí usersCount = 3
```

---

#### 2.4. Build Result Object

```typescript
dateRange.push({
  date: dateStr, // "2025-10-10"
  users: usersCount, // 3
  posts: postsCount, // 15
  bookmarks: 0, // TODO: ch∆∞a c√≥ API
});
```

**K·∫øt qu·∫£ cu·ªëi c√πng** (v√≠ d·ª•):

```json
[
  { "date": "2025-10-06", "users": 5, "posts": 12, "bookmarks": 0 },
  { "date": "2025-10-07", "users": 3, "posts": 8, "bookmarks": 0 },
  { "date": "2025-10-08", "users": 7, "posts": 20, "bookmarks": 0 },
  { "date": "2025-10-09", "users": 2, "posts": 5, "bookmarks": 0 },
  { "date": "2025-10-10", "users": 10, "posts": 25, "bookmarks": 0 },
  { "date": "2025-10-11", "users": 4, "posts": 15, "bookmarks": 0 },
  { "date": "2025-10-12", "users": 6, "posts": 18, "bookmarks": 0 }
]
```

---

### B∆∞·ªõc 3: Render Chart (DashboardCharts.tsx)

**File**: `apps/web/app/(dashboard)/admin/_components/DashboardCharts.tsx`

```typescript
<LineChart data={timeSeriesData}>
  {/* Grid n·ªÅn */}
  <CartesianGrid strokeDasharray="3 3" stroke="#374151" />

  {/* Tr·ª•c X (ng√†y th√°ng) */}
  <XAxis
    dataKey="date"
    tickFormatter={(value) => {
      const date = new Date(value);
      return `${date.getDate()}/${date.getMonth() + 1}`;
    }}
  />

  {/* Tr·ª•c Y (s·ªë l∆∞·ª£ng) */}
  <YAxis stroke="#9ca3af" />

  {/* Tooltip khi hover */}
  <Tooltip />

  {/* Legend (ch√∫ th√≠ch) */}
  <Legend />

  {/* ƒê∆∞·ªùng m√†u xanh d∆∞∆°ng: Users */}
  <Line
    type="monotone"
    dataKey="users"
    stroke={COLORS.blue}
    name="Users M·ªõi"
    strokeWidth={2}
    dot={{ r: 4 }}
  />

  {/* ƒê∆∞·ªùng m√†u xanh l√°: Posts */}
  <Line
    type="monotone"
    dataKey="posts"
    stroke={COLORS.green}
    name="Posts M·ªõi"
    strokeWidth={2}
    dot={{ r: 4 }}
  />
</LineChart>
```

**Gi·∫£i th√≠ch c√°c th√†nh ph·∫ßn:**

1. **CartesianGrid**: L∆∞·ªõi n·ªÅn gi√∫p ƒë·ªçc gi√° tr·ªã d·ªÖ h∆°n
2. **XAxis**: Tr·ª•c ngang hi·ªÉn th·ªã ng√†y (6/10, 7/10, ...)
3. **YAxis**: Tr·ª•c d·ªçc hi·ªÉn th·ªã s·ªë l∆∞·ª£ng (0, 5, 10, 15, ...)
4. **Tooltip**: Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt khi hover chu·ªôt
5. **Legend**: Ch√∫ th√≠ch m√†u s·∫Øc (Users M·ªõi, Posts M·ªõi)
6. **Line (users)**: ƒê∆∞·ªùng m√†u xanh d∆∞∆°ng bi·ªÉu di·ªÖn users
7. **Line (posts)**: ƒê∆∞·ªùng m√†u xanh l√° bi·ªÉu di·ªÖn posts

---

## üéØ V√≠ D·ª• Minh H·ªça

### Scenario: H√¥m nay l√† 12/10/2025

#### Input Data t·ª´ Database:

**Users:**

```
ID  | fullName | createdAt
----|----------|------------------
1   | John     | 2025-10-06 10:30
2   | Alice    | 2025-10-07 14:20
3   | Bob      | 2025-10-07 16:45
4   | Carol    | 2025-10-10 08:00
5   | Dave     | 2025-10-10 12:30
6   | Eve      | 2025-10-10 20:15
7   | Frank    | 2025-10-12 09:00
```

**Posts:**

```
ID  | title      | createdAt
----|------------|------------------
1   | Post A     | 2025-10-06 11:00
2   | Post B     | 2025-10-07 15:30
3   | Post C     | 2025-10-08 10:20
4   | Post D     | 2025-10-10 13:45
5   | Post E     | 2025-10-12 08:30
```

#### Processing:

```
06/10: 1 user (John), 1 post (Post A)
07/10: 2 users (Alice, Bob), 1 post (Post B)
08/10: 0 users, 1 post (Post C)
09/10: 0 users, 0 posts
10/10: 3 users (Carol, Dave, Eve), 1 post (Post D)
11/10: 0 users, 0 posts
12/10: 1 user (Frank), 1 post (Post E)
```

#### Output Data:

```json
[
  { "date": "2025-10-06", "users": 1, "posts": 1 },
  { "date": "2025-10-07", "users": 2, "posts": 1 },
  { "date": "2025-10-08", "users": 0, "posts": 1 },
  { "date": "2025-10-09", "users": 0, "posts": 0 },
  { "date": "2025-10-10", "users": 3, "posts": 1 },
  { "date": "2025-10-11", "users": 0, "posts": 0 },
  { "date": "2025-10-12", "users": 1, "posts": 1 }
]
```

#### Chart Visualization:

```
Users |
  3   |              *
      |
  2   |    *
      |
  1   | *              *     *
      |
  0   |____*___*_______*____*___
      6   7   8   9  10  11  12

Posts |
  1   | *  *  *        *     *
      |
  0   |______*___*_______*______
      6   7   8   9  10  11  12
```

---

## üîß Performance & Optimization

### V·∫•n ƒê·ªÅ Hi·ªán T·∫°i:

‚ùå **Fetch TO√ÄN B·ªò users & posts** m·ªói l·∫ßn

- N·∫øu c√≥ 10,000 users v√† 50,000 posts ‚Üí r·∫•t ch·∫≠m
- L√£ng ph√≠ bandwidth
- Client ph·∫£i filter to√†n b·ªô data

### Gi·∫£i Ph√°p T·ªëi ∆Øu (N√™n l√†m trong t∆∞∆°ng lai):

‚úÖ **Backend API n√™n filter s·∫µn:**

```typescript
GET /api/analytics/timeseries?days=7

// Backend ch·ªâ tr·∫£ v·ªÅ data ƒë√£ ƒë∆∞·ª£c aggregate
Response:
[
  { "date": "2025-10-06", "usersCount": 1, "postsCount": 1 },
  { "date": "2025-10-07", "usersCount": 2, "postsCount": 1 },
  ...
]
```

‚úÖ **L·ª£i √≠ch:**

- Faster response time
- Less data transfer
- More accurate v·ªõi SQL aggregation
- Scalable khi data l·ªõn

### SQL Query T·ªëi ∆Øu (G·ª£i √Ω cho Backend):

```sql
-- Count users per day (last 7 days)
SELECT
  DATE(created_at) as date,
  COUNT(*) as users_count
FROM accounts
WHERE created_at >= NOW() - INTERVAL '7 days'
GROUP BY DATE(created_at)
ORDER BY date ASC;

-- Count posts per day (last 7 days)
SELECT
  DATE(created_at) as date,
  COUNT(*) as posts_count
FROM posts
WHERE created_at >= NOW() - INTERVAL '7 days'
GROUP BY DATE(created_at)
ORDER BY date ASC;
```

---

## üìä Data Structure

### TimeSeriesData Interface:

```typescript
export interface TimeSeriesData {
  date: string; // ISO date string: "2025-10-12"
  users: number; // S·ªë users m·ªõi trong ng√†y
  posts: number; // S·ªë posts m·ªõi trong ng√†y
  bookmarks: number; // TODO: ch∆∞a implement
}
```

---

## üé® Customization

### Thay ƒë·ªïi s·ªë ng√†y:

```typescript
// 7 ng√†y (hi·ªán t·∫°i)
queryFn: () => getTimeSeriesData(7);

// 14 ng√†y
queryFn: () => getTimeSeriesData(14);

// 30 ng√†y
queryFn: () => getTimeSeriesData(30);
```

### Thay ƒë·ªïi m√†u s·∫Øc:

```typescript
// File: DashboardCharts.tsx
const COLORS = {
  blue: '#3b82f6', // Users ‚Üí ƒë·ªïi th√†nh m√†u kh√°c
  green: '#10b981', // Posts ‚Üí ƒë·ªïi th√†nh m√†u kh√°c
};
```

### Thay ƒë·ªïi refresh interval:

```typescript
// File: page.tsx
refetchInterval: 60000, // 60 gi√¢y (hi·ªán t·∫°i)
refetchInterval: 30000, // 30 gi√¢y (nhanh h∆°n)
refetchInterval: 120000, // 2 ph√∫t (ch·∫≠m h∆°n)
```

---

## üêõ Edge Cases & Handling

### 1. Kh√¥ng c√≥ data:

```typescript
// N·∫øu kh√¥ng c√≥ users/posts trong ng√†y
{ "date": "2025-10-09", "users": 0, "posts": 0 }
// ‚Üí Chart s·∫Ω hi·ªÉn th·ªã ƒëi·ªÉm ·ªü y = 0
```

### 2. API Error:

```typescript
// React Query t·ª± ƒë·ªông handle
if (timeSeriesError) {
  // Show error message trong UI
  return <ErrorComponent />;
}
```

### 3. Loading State:

```typescript
if (timeSeriesLoading) {
  // Show skeleton loader
  return <LoadingSkeleton />;
}
```

---

## üìà Use Cases

### Admin c√≥ th·ªÉ:

1. ‚úÖ Xem xu h∆∞·ªõng tƒÉng tr∆∞·ªüng users/posts theo ng√†y
2. ‚úÖ So s√°nh gi·ªØa users v√† posts (c√≥ correlation kh√¥ng?)
3. ‚úÖ Ph√°t hi·ªán spike (tƒÉng ƒë·ªôt ng·ªôt) ‚Üí ƒëi·ªÅu tra nguy√™n nh√¢n
4. ‚úÖ Ph√°t hi·ªán drop (gi·∫£m ƒë·ªôt ng·ªôt) ‚Üí c√≥ v·∫•n ƒë·ªÅ?
5. ‚úÖ ƒê√°nh gi√° hi·ªáu qu·∫£ c·ªßa marketing campaigns

### V√≠ d·ª• insights:

- "Posts tƒÉng m·∫°nh v√†o 10/10 nh∆∞ng users kh√¥ng tƒÉng ‚Üí Users c≈© ƒëang active"
- "Users tƒÉng v√†o cu·ªëi tu·∫ßn ‚Üí C√≥ th·ªÉ do ads campaign"
- "C·∫£ users v√† posts ƒë·ªÅu gi·∫£m ‚Üí C·∫ßn ki·ªÉm tra h·ªá th·ªëng"

---

## üîÆ Future Enhancements

1. **More Metrics**:
   - Bookmarks per day
   - Views per day
   - Revenue per day (n·∫øu c√≥ monetization)

2. **Date Range Selector**:
   - User ch·ªçn 7/14/30/90 ng√†y
   - Custom date range picker

3. **Comparison**:
   - So s√°nh v·ªõi tu·∫ßn tr∆∞·ªõc
   - So s√°nh v·ªõi th√°ng tr∆∞·ªõc
   - Year-over-year comparison

4. **Export Data**:
   - Download as CSV
   - Download as PDF report

5. **Real-time Updates**:
   - WebSocket cho real-time updates
   - Live counter animation

---

## üìù Summary

### Logic T√≥m T·∫Øt:

1. **Fetch** to√†n b·ªô users & posts t·ª´ DB
2. **Loop** 7 l·∫ßn (t·ª´ 6 ng√†y tr∆∞·ªõc ‚Üí h√¥m nay)
3. **Filter** users & posts theo t·ª´ng ng√†y
4. **Count** s·ªë l∆∞·ª£ng
5. **Build** array of data points
6. **Render** LineChart v·ªõi Recharts
7. **Auto-refresh** m·ªói 60 gi√¢y

### Key Points:

- ‚úÖ Simple nh∆∞ng hi·ªáu qu·∫£ cho prototype
- ‚ö†Ô∏è Kh√¥ng scalable v·ªõi data l·ªõn
- üéØ D·ªÖ customize v√† extend
- üìä Cung c·∫•p insights valuable cho admin

---

**Created**: October 12, 2025  
**Author**: Development Team  
**Related Files**:

- `apps/web/lib/api/adminApi.ts`
- `apps/web/app/(dashboard)/admin/page.tsx`
- `apps/web/app/(dashboard)/admin/_components/DashboardCharts.tsx`
